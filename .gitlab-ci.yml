---
# ref: https://docs.gitlab.com/ee/ci/yaml/README.html#workflowrules-templates
include:
    - template: 'Workflows/MergeRequest-Pipelines.gitlab-ci.yml'

image: docker:19.03.7
services:
    - docker:19.03.7-dind

variables:
    BRANCH: $CI_COMMIT_REF_NAME
    # Use TLS https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#tls-enabled
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: /certs
    DOCKER_DRIVER: overlay2
    DOCKER_BUILDKIT: 1
    # docker build
    # we can only build to one image name, everything has to be done under tags
    BUILDER_COMMIT_TAG: builder-$CI_COMMIT_REF_SLUG
    BUILDER_LATEST_TAG: builder-latest
    PROD_COMMIT_TAG: prod-$CI_COMMIT_REF_SLUG
    PROD_LATEST_TAG: prod-latest
    PIPELINE_ID: anno-$CI_PIPELINE_ID

# include:
#     - template: Container-Scanning.gitlab-ci.yml
#     - template: Dependency-Scanning.gitlab-ci.yml
#     - template: SAST.gitlab-ci.yml
#     - template: License-Scanning.gitlab-ci.yml
# Gitlab security scans
#
# dependency_scanning:
#     stage: test
#     only:
#         - tags
#         - dev
#         - master
#
# container_scanning:
#     stage: test
#     only:
#         - tags
#         - dev
#         - master
#
# sast:
#     stage: test
#     only:
#         - tags
#         - dev
#         - master
#
# license_scanning:
#     stage: test
#     only:
#         - tags
#         - dev
#         - master

stages:
    - build
    - test
    - update_latest
    - release

.image_setup: &image-setup
    before_script:
        - apk add --update make git
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

build_builder:
    stage: build
    extends: .image_setup
    script:
        - make build-annobuilder ANNOBUILDER_IMAGE_NAME="$CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG" BUILD_OPTS="--cache-from $CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG --cache-from $CI_REGISTRY_IMAGE:$BUILDER_LATEST_TAG --cache-from=$CI_REGISTRY_IMAGE:$PROD_LATEST_TAG"
        - docker push $CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG
    tags:
        - bastion

build_prod:
    stage: build
    extends: .image_setup
    script:
        - make build IMAGE_NAME="$CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG" BUILD_OPTS="--cache-from=$CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG --cache-from=$CI_REGISTRY_IMAGE:$PROD_LATEST_TAG --cache-from=$CI_REGISTRY_IMAGE:$BUILDER_LATEST_TAG"
        - docker push $CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG
    tags:
        - bastion

check_do:
    stage: test
    extends: .image_setup
    script:
        - docker pull $CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG | cat || true
        - make verify-digital-ocean ANNOBUILDER_IMAGE_NAME=$CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG
    tags:
        - bastion

check_pipenv:
    stage: test
    extends: .image_setup
    script:
        - pipenv check
    tags:
        - bastion

run_pytest:
    extends: .image_setup
    stage: test
    script:
        - docker pull $CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG | cat || true
        - docker pull $CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG | cat || true
        - make download-data ANNOBUILDER_IMAGE_NAME=$CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG RUN_CMD_ARGS="--skip-validation --force"
        - make test IMAGE_NAME=$CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG
        - make test-ops IMAGE_NAME=$CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG
    tags:
        - do-large

update_latest_builder:
    stage: update_latest
    extends: .image_setup
    script:
        - docker pull $CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG | cat || true
        - docker tag $CI_REGISTRY_IMAGE:$BUILDER_COMMIT_TAG $CI_REGISTRY_IMAGE:$BUILDER_LATEST_TAG
        - docker push $CI_REGISTRY_IMAGE:$BUILDER_LATEST_TAG
    tags:
        - bastion

update_anno_latest:
    stage: update_latest
    extends: .image_setup
    script:
        - docker pull $CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG | cat || true
        - docker tag $CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG $CI_REGISTRY_IMAGE:$PROD_LATEST_TAG
        - docker push $CI_REGISTRY_IMAGE:$PROD_LATEST_TAG
    tags:
        - bastion

release_singularity:
    stage: release
    extends: .image_setup
    script:
        - docker pull $CI_REGISTRY_IMAGE:$PROD_COMMIT_TAG | cat || true
        - make singularity-release IMAGE_NAME=$CI_REGISTRY_IMAGE
    artifacts:
        name: 'anno-$CI_COMMIT_REF_NAME-singularity'
        paths:
            - release/
        expire_in: 30 days
    rules:
        - if: '$CI_PIPELINE_SOURCE == "api"'
